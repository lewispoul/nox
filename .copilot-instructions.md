# .copilot-instructions.md

## 📚 **SESSION START PROTOCOL**

**🚨 CRITICAL FILE PLACEMENT RULE:** 
**NEVER create .md files in `/home/lppoulin/nox-api-src/` (root directory)**
**ALWAYS use organized docs/ subdirectories (see DOCUMENTATION ORGANIZATION section)**

**MANDATORY FIRST ACTIONS FOR EVERY NEW CHAT SESSION:**

1. **📖 Read Current Project Status**
   ```bash
   # Always read these files first to understand current state:
   - docs/PROJECT_STATUS_[LATEST_DATE].md   # Current project overview ⚠️ (in docs/)
   - docs/SESSION_SUMMARY_[LATEST_DATE].md  # Latest session achievements ⚠️ (in docs/)  
   - docs/guides/README_AGENT.md            # Agent capabilities and usage
   - agent/tasks/backlog.yaml               # Current task priorities
   ```

2. **🔍 Check Git Repository State**
   ```bash
   git status                           # Current branch and changes
   git branch -a                        # Available branches
   git log --oneline -5                 # Recent commits
   ```

3. **🎯 Identify Current Context**
   - Determine active development branch
   - Review pending tasks and priorities
   - Check for any incomplete implementations
   - Understand user's immediate objectives

---

## 📝 **DOCUMENTATION PROTOCOLS**

### **🎯 MILESTONE COMPLETION DOCUMENTATION**

**When ANY milestone, feature, or major task is completed:**

1. **Create Progress Report** - `docs/PROGRESS_[TASK-ID]_[DATE].md` ⚠️ (in docs/, NOT root)
   - Technical implementation details
   - Architecture changes made
   - Test results and validation
   - Business impact analysis
   - Integration points and dependencies

2. **Update Project Status** - `docs/PROJECT_STATUS_[DATE].md` ⚠️ (in docs/, NOT root)
   - Current system architecture status
   - Completed vs pending tasks
   - Git repository state  
   - Next development priorities
   - Technical foundation status

### **🔄 SESSION END DOCUMENTATION**

**At the end of EVERY development session:**

1. **Create Session Summary** - `docs/SESSION_SUMMARY_[DATE].md` ⚠️ (in docs/, NOT root)
   - Complete session overview
   - All achievements and implementations
   - Technical architecture changes
   - Development methodology innovations
   - Next session preparation information

2. **Update Backlog** - `agent/tasks/backlog.yaml`
   - Mark completed tasks as done
   - Update priorities based on progress
   - Add new tasks discovered during development

### **📊 TESTING AND VALIDATION DOCUMENTATION**

**When tests are implemented or validation is performed:**

1. **Document Test Results** in appropriate progress report
   - Test command executed and output
   - Pass/fail status with explanations
   - Coverage analysis if applicable
   - Performance metrics if relevant

2. **Create Test Guides** when appropriate - `docs/testing/[COMPONENT]_TEST_GUIDE.md`
   - How to run specific test suites
   - Expected results and troubleshooting
   - Test data and fixtures explanation

### **🏗️ ARCHITECTURE AND DESIGN DOCUMENTATION**

**When new systems or significant changes are implemented:**

1. **Architecture Documentation** - `docs/architecture/[SYSTEM]_ARCHITECTURE.md`
   - System design overview
   - Component relationships  
   - Data flow diagrams (ASCII art acceptable)
   - Integration points and APIs

2. **Implementation Guides** - `docs/guides/[FEATURE]_IMPLEMENTATION_GUIDE.md`
   - Step-by-step implementation process
   - Code examples and patterns
   - Best practices and gotchas
   - Troubleshooting common issues

---

## 📂 **DOCUMENTATION ORGANIZATION**

### **🚨 MANDATORY FILE PLACEMENT RULES**

**ALWAYS CREATE NEW .md FILES IN APPROPRIATE DOCS SUBDIRECTORIES:**

- ❌ **NEVER** create .md files in `/home/lppoulin/nox-api-src/` (root)
- ✅ **ALWAYS** use organized docs structure below

### **Root Level Documentation (EXCEPTIONS ONLY)**
- `PROJECT_STATUS_[DATE].md` - Comprehensive project status (create in `docs/`)
- `SESSION_SUMMARY_[DATE].md` - Session achievements and progress (create in `docs/`) 
- `PROGRESS_[TASK-ID]_[DATE].md` - Specific task/milestone documentation (create in `docs/`)
- `README.md` and `.copilot-instructions.md` - Only files that belong in root

### **Organized Documentation Structure (USE THESE LOCATIONS)**
```
docs/
├── architecture/          # System design and architecture docs
│   └── [SYSTEM]_ARCHITECTURE.md
├── guides/               # Implementation and usage guides  
│   └── [FEATURE]_GUIDE.md, API_USER_GUIDE.md, etc.
├── testing/              # Test documentation and guides
│   └── [COMPONENT]_TEST_GUIDE.md
├── deployment-guides/    # Deployment and operations docs
│   └── PRODUCTION_DEPLOYMENT_GUIDE.md, OPS_*.md, etc.
├── milestone-reports/    # Completion reports and milestones
│   └── SECTION_*_COMPLETION.md, M*_COMPLETION.md
├── session-reports/      # Session summaries and reports
│   └── SESSION_COMPLETION_REPORT_*.md
├── progress-reports/     # Progress tracking documents
│   └── COMPREHENSIVE_PROGRESS_REPORT.md, etc.
├── planning/            # Planning documents and roadmaps
│   └── PHASE*_PLAN.md, M*_PLAN.md
└── api/                 # API documentation and examples
    └── API_SPECIFICATION.md, ENDPOINT_DOCS.md

**TOP-LEVEL DOCS (in docs/ not root):**
├── PROJECT_STATUS_[DATE].md    # ← CREATE HERE, NOT ROOT
├── SESSION_SUMMARY_[DATE].md   # ← CREATE HERE, NOT ROOT  
└── PROGRESS_[TASK-ID].md       # ← CREATE HERE, NOT ROOT
```

**🚨 CRITICAL:** When creating ANY new .md file, determine the appropriate subdirectory first, then use the full path like `docs/guides/NEW_FEATURE_GUIDE.md`

### **Agent-Specific Documentation**
```
agent/
├── payloads/            # Offline plan files for deterministic execution
├── tasks/               # Task backlogs and priority management
└── docs/                # Agent-specific implementation documentation
```

---

## 🎯 **NOX AGENT DEVELOPMENT CONTEXT**

### **Current Project Status (Updated August 19, 2025)**
- ✅ **File-Operations System v0.2** - Production-ready autonomous coding
- ✅ **Offline Plan Injection** - Deterministic execution without OpenAI API
- ✅ **XTBA-001** - XTB JSON parser and runner implementation complete
- 🔄 **Next Priority:** JOBS-002 (job queue management with state polling)

### **Active Development Areas**
- **NOX Agent:** Autonomous coding system with LLM integration
- **XTB Integration:** Quantum chemistry computation workflows  
- **Job Management:** Asynchronous task processing with Dramatiq
- **API Development:** FastAPI-based REST services

### **Safety and Quality Standards**
- All agent operations include comprehensive safety guardrails
- File operations restricted to approved allowlists
- Test-driven development with pytest-asyncio
- Comprehensive error handling with custom exceptions
- Git-based version control with feature branches

---

## 🔄 **DEVELOPMENT WORKFLOW**

### **Standard Development Process**
1. **Start:** Read documentation to understand current state
2. **Plan:** Identify task priorities and dependencies
3. **Implement:** Use agent or manual development as appropriate
4. **Test:** Validate functionality with comprehensive testing
5. **Document:** Create appropriate documentation per protocols above
6. **Commit:** Clean git commits with descriptive messages

### **Agent Development Guidelines**
- Use file-operations system for reliable code modification
- Leverage offline plan injection for deterministic tasks
- Maintain all safety systems (allowlists, size limits, branch protection)
- Comprehensive testing before deployment
- Document all agent capabilities and limitations

### **Documentation Quality Standards**
- **Comprehensive:** Cover all aspects of implementation and usage
- **Current:** Update with every significant change or milestone
- **Searchable:** Use consistent naming and organization
- **Actionable:** Include specific commands, examples, and procedures
- **Context-Rich:** Provide sufficient information for session continuity

---

## 🚀 **WORKSPACE SCOPE AND RULES**

### **Primary Focus**
This workspace is dedicated to **NOX Agent development** and related computational chemistry workflow automation.

### **Strict Development Rules**
- **NO IAM 2.0 work** in this workspace (use separate window/repo)
- **Always start** with documentation review per SESSION START PROTOCOL
- **Always end** with appropriate documentation per protocols above
- **Maintain git hygiene** with feature branches and clean commits
- **Preserve safety systems** throughout all development work

### **Documentation is Mandatory**
- Every session must produce appropriate documentation
- Every milestone must be comprehensively documented  
- Every architectural change must be explained and recorded
- Every test implementation must be documented with results

**The goal is seamless session continuity and comprehensive project knowledge preservation.** 🎯

---

*These instructions ensure consistent, high-quality documentation practices that enable efficient development across multiple sessions and maintain complete project context.*

# 🛠 Copilot Task — Fix E2E Echo + XTB Hermetic Mode

We need to fix two E2E test failures:

1. **Echo jobs** must return the payload under both keys (`payload` and `echo`).
2. **XTB jobs in hermetic/local mode** must short-circuit to a fake fast result when the `xtb` binary is not present, so CI doesn’t hang.

## ✅ Implementation Details

### 1. Update `echo_worker`

```python
# queue.py (or equivalent)

def echo_worker(payload: dict) -> dict:
    # Return original payload under both keys so tests can assert consistently
    return {
        "payload": payload,
        "echo": payload,
    }
```

### 2. Update `run_xtb_calculation_local`

```python
# queue.py (or equivalent)
import shutil

def run_xtb_calculation_local(payload: dict) -> dict:
    # If xtb binary isn’t available, short-circuit with fake result
    if shutil.which("xtb") is None:
        return {
            "payload": payload,
            "result": {
                "energy": -40.12,
                "gap": 3.21,
                "dipole": 1.84,
                "artifacts": [],
            },
            "state": "completed",
        }
    # otherwise: run real XTB workflow
    ...
```

## 🧪 Verification

Run hermetic tests in local mode:

```bash
export JOBS_FORCE_LOCAL=1
pytest tests/e2e -q
```

Expected:

* `test_e2e_echo_local_mode` passes (`payload.x == 42`)
* `test_e2e_xtb_with_cubes` finishes with state `completed` and fake results

Run full suite to confirm nothing else broke:

```bash
pytest -q
```

---



# Configuration Logrotate pour Nox API
# Fichier: /etc/logrotate.d/nox-api
# Généré automatiquement - Étape 6 COPILOT_PLAN.md

/var/log/nox-api/*.log {
    # Rotation quotidienne
    daily
    
    # Conserver 30 jours de logs (30 fichiers)
    rotate 30
    
    # Compresser les logs anciens (sauf le plus récent)
    compress
    delaycompress
    
    # Ne pas générer d'erreur si le fichier de log n'existe pas
    missingok
    
    # Ne pas faire la rotation si le fichier est vide
    notifempty
    
    # Créer un nouveau fichier avec les bonnes permissions après rotation
    create 644 nox nox
    
    # Utiliser la date comme suffixe (YYYYMMDD)
    dateext
    dateformat -%Y%m%d
    
    # Actions post-rotation
    postrotate
        # Envoyer un signal USR1 au processus pour rouvrir les logs
        # Note: FastAPI/Uvicorn ne supporte pas forcément USR1, mais on tente
        if /bin/pidof python3 > /dev/null; then
            # Redémarrer le service pour rouvrir les logs
            /bin/systemctl reload-or-restart nox-api > /dev/null 2>&1 || true
        fi
    endscript
    
    # Configuration avancée
    
    # Copier et tronquer au lieu de déplacer (preserve file descriptor)
    copytruncate
    
    # Limite de taille: rotation si > 50MB même avant la rotation quotidienne
    size 50M
    
    # Permissions du répertoire parent
    su nox nox
}

# alert_rules.yml - Prometheus alert rules for Nox monitoring
groups:
  - name: nox.rules
    rules:
      # API Health Alerts
      - alert: NoxAPIDown
        expr: up{job="nox-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Nox API is down"
          description: "Nox API has been down for more than 1 minute."

      # High Request Rate
      - alert: NoxHighRequestRate
        expr: rate(nox_requests_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High request rate on Nox API"
          description: "Request rate is {{ $value }} requests/second."

      # High Error Rate
      - alert: NoxHighErrorRate
        expr: rate(nox_requests_total{status=~"4.*|5.*"}[5m]) > 1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "High error rate on Nox API"
          description: "Error rate is {{ $value }} errors/second."

      # High Latency
      - alert: NoxHighLatency
        expr: histogram_quantile(0.95, rate(nox_latency_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency on Nox API"
          description: "95th percentile latency is {{ $value }} seconds."

      # User Quota Alerts (for future implementation)
      - alert: NoxUserQuotaExceeded
        expr: nox_user_quota_usage_ratio > 0.9
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "User quota almost exceeded"
          description: "User {{ $labels.user }} has used {{ $value | humanizePercentage }} of their quota."

      # Sandbox Storage Alert
      - alert: NoxSandboxStorageFull
        expr: nox_sandbox_files_total > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Sandbox storage getting full"
          description: "Sandbox contains {{ $value }} files."
